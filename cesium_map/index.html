<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Urban Hazard Digital Twin - Chennai</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bitcount+Prop+Single+Ink:wght@100..900&display=swap" rel="stylesheet">
    <style>
        
.bitcount-prop-single-ink {
  font-family: "Bitcount Prop Single Ink", system-ui;
  font-optical-sizing: auto;
  font-weight: heavy;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "CRSV" 0.5,
    "ELSH" 0,
    "ELXP" 0,
    "SZP1" 0,
    "SZP2" 0,
    "XPN1" 0,
    "XPN2" 0,
    "YPN1" 0,
    "YPN2" 0;
}
        html, body, #cesiumContainer {

            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;

        }
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 350px;
            z-index: 1000;
        }
        .risk-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .risk-high { background-color: #e74c3c; }
        .risk-medium { background-color: #f39c12; }
        .risk-low { background-color: #27ae60; }
        .risk-very-high { background-color: #8e44ad; }
    </style>
</head>
<body>
    <div id="cesiumContainer" class="bitcount-prop-single-ink"></div>
    
    <div class="info-panel bitcount-prop-single-ink">
        <h1>üèôÔ∏è AI Urban Hazard Digital Twin</h1>
        <h3>Chennai Metropolitan Area</h3>
        <p>Real-time multi-hazard risk assessment system integrating AI predictions with 3D urban modeling.</p>
        
        <div id="location-info">
            <p>Click on any hazard marker to view detailed risk analysis</p>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>System Status:</strong> <span style="color: #27ae60;">‚óè Active</span><br>
            <strong>Last Update:</strong> <span id="update-time">Loading...</span><br>
            <strong>Locations Monitored:</strong> <span id="location-count">100</span>
        </div>
    </div>
    
    <div class="risk-legend bitcount-prop-single-ink">
        <h3>Risk Legend</h3>
        <div class="legend-item">
            <div class="legend-color risk-low"></div>
            <span>Low Risk (0-30%)</span>
        </div>
        <div class="legend-item bitcount-prop-single-ink">
            <div class="legend-color risk-medium"></div>
            <span>Medium Risk (30-70%)</span>
        </div>
        <div class="legend-item bitcount-prop-single-ink">
            <div class="legend-color risk-high"></div>
            <span>High Risk (70-90%)</span>
        </div>
        <div class="legend-item bitcount-prop-single-ink">
            <div class="legend-color risk-very-high"></div>
            <span>Very High Risk (90-100%)</span>
        </div>
    </div>

    <script>
    // Initialize Cesium Viewer
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZDcxMmNhOC1iYTY0LTQzMGEtODU0Yy1kNDQwMDdlNzE2ZDEiLCJpZCI6MzQ0OTY3LCJpYXQiOjE3NTg5MTU4Mzh9.WqnIypYkS-2dwK0we2-4I9fNYcSzfjq2bXRNoyUxUL4';
    
    // ...existing code...
const viewer = new Cesium.Viewer('cesiumContainer', {
    animation: false,
    timeline: false,
    homeButton: false,
    geocoder: false,
    baseLayerPicker: false
});

// ...existing code...

    // Center on Chennai
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(80.2707, 13.0827, 5000),
        orientation: { heading: 0.0, pitch: -0.5, roll: 0.0 }
    });

    // Load hazard data
    fetch('../output/city_hazards.geojson')
        .then(response => response.json())
        .then(data => {
            document.getElementById('update-time').textContent = new Date().toLocaleString();
            document.getElementById('location-count').textContent = data.features.length;
            
            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                
                // Determine risk level and color
                let riskColor = Cesium.Color.GREEN;
                let riskLevel = "Low";
                
                if (props.overall_risk >= 90) {
                    riskColor = Cesium.Color.PURPLE;
                    riskLevel = "Very High";
                } else if (props.overall_risk >= 70) {
                    riskColor = Cesium.Color.RED;
                    riskLevel = "High";
                } else if (props.overall_risk >= 30) {
                    riskColor = Cesium.Color.ORANGE;
                    riskLevel = "Medium";
                }
                
                // Create point entity with risk visualization
                const entity = viewer.entities.add({
                    name: 'Location ' + props.cell_id,  // FIXED: Removed template literal issue
                    position: Cesium.Cartesian3.fromDegrees(coords[0], coords[1]),
                    point: {
                        pixelSize: 15 + (props.overall_risk / 5),
                        color: riskColor,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                    },
                    label: {
                        text: props.overall_risk + '%',  // FIXED: Removed template literal
                        font: '12pt Arial',
                        pixelOffset: new Cesium.Cartesian2(0, -20),
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                    },
                    description: 
                        '<div style="padding: 10px; max-width: 300px;">' +
                        '<h3>Hazard Risk Analysis</h3>' +
                        '<table style="width: 100%; border-collapse: collapse;">' +
                        '<tr><td><strong>Overall Risk:</strong></td><td style="color: ' + riskColor.toCssColorString() + '">' + props.overall_risk + '% (' + riskLevel + ')</td></tr>' +
                        '<tr><td>Heat Risk:</td><td>' + props.heat_risk + '%</td></tr>' +
                        '<tr><td>Air Quality Risk:</td><td>' + props.air_quality_risk + '%</td></tr>' +
                        '<tr><td>Flood Risk:</td><td>' + props.flood_risk + '%</td></tr>' +
                        '</table>' +
                        '<p style="margin-top: 10px; font-size: 12px; color: #666;">' +
                        'AI-generated risk assessment based on real-time urban data.' +
                        '</p>' +
                        '</div>'
                });
            });
            
            console.log('Hazard data loaded successfully');
        })
        .catch(error => {
            console.error('Error loading hazard data:', error);
            document.getElementById('location-info').innerHTML = 
                '<p style="color: red;">Error loading hazard data. Please run the Python script first.</p>';
            
            // Add demo data if real data fails
            addDemoData();
        });

    function addDemoData() {
        // Add demo markers if real data fails to load
        const demoPoints = [
            {lon: 80.2707, lat: 13.0827, risk: 75, name: "Central Chennai"},
            {lon: 80.2750, lat: 13.0850, risk: 45, name: "Northern Zone"},
            {lon: 80.2650, lat: 13.0800, risk: 85, name: "Southern Zone"}
        ];
        
        demoPoints.forEach(point => {
            const riskColor = point.risk >= 70 ? Cesium.Color.RED : 
                             point.risk >= 30 ? Cesium.Color.ORANGE : Cesium.Color.GREEN;
            
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(point.lon, point.lat),
                point: {
                    pixelSize: 20,
                    color: riskColor,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: point.risk + '% - ' + point.name,
                    font: '14px sans-serif',
                    pixelOffset: new Cesium.Cartesian2(0, 30)
                }
            });
        });
        
        document.getElementById('location-count').textContent = demoPoints.length;
        document.getElementById('location-info').innerHTML = 
            '<p style="color: orange;">Using demo data - run Python script for real analysis</p>';
    }

    // Add some 3D buildings for realism
    function addUrbanFeatures() {
        const buildingPositions = [
            [80.2707, 13.0827], [80.2750, 13.0850], [80.2650, 13.0800]
        ];
        
        buildingPositions.forEach((pos, index) => {
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(pos[0], pos[1]),
                box: {
                    dimensions: new Cesium.Cartesian3(150, 150, 50 + index * 30),
                    material: Cesium.Color.GRAY.withAlpha(0.7),
                    outline: true,
                    outlineColor: Cesium.Color.BLACK
                }
            });
        });
    }

    addUrbanFeatures();
    console.log('3D Digital Twin initialized successfully');
    </script>
</body>
</html>